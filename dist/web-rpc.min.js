!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WebRPC=e()}(this,function(){"use strict";function t(t){return Object(t)===t}function e(t){return t instanceof ArrayBuffer}function o(o){var i=[];if(e(o))i.push(o);else if(t(o))for(var n in o)e(o[n])&&i.push(o[n]);return i}function i(){return Math.floor(1e6*(1+Math.random())).toString(16)}var n=function(){this.events=Object.create(null)};n.prototype.on=function(t,e){var o=this.events[t];o||(o=[],this.events[t]=o),o.push(e)},n.prototype.off=function(t,e){var o=this.events[t];if(o){var i=o.indexOf(e);-1!==i&&o.splice(i,1)}},n.prototype.emit=function(t,e){var o=this.events[t];if(o)for(var i=0;i<o.length;i++)o[i](e)};var r=function(t){function e(e){var o=e.worker;t.call(this),this.worker=o,this.calls={},this.timeouts={},this.listen()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.listen=function(){this.worker.addEventListener("message",this.handler.bind(this))},e.prototype.handler=function(t){var e=t.data,o=e.method,i=e.eventName,n=e.data,r=e.uid;o&&this.resolve(r,n),i&&this.emit(i,n)},e.prototype.resolve=function(t,e){this.calls[t]&&(clearTimeout(this.timeouts[t]),this.calls[t](e),delete this.timeouts[t],delete this.calls[t])},e.prototype.call=function(t,e,n){var r=this;void 0===n&&(n={});var s=n.timeout;void 0===s&&(s=2e3);var a=i(),u=o(e);return this.worker.postMessage({method:t,uid:a,data:e},u),new Promise(function(e,o){r.timeouts[a]=setTimeout(function(){return o(new Error("RPC timeout exceeded for '"+t+"' call"))},s),r.calls[a]=e})},e}(n),s=function(t){this.methods=t,this.listen()};return s.prototype.listen=function(){self.addEventListener("message",this.handler.bind(this))},s.prototype.handler=function(t){var e=t.data,o=e.method,i=e.uid,n=e.data;this.methods[o]&&Promise.all([o,i,this.methods[o](n)]).then(this.reply)},s.prototype.reply=function(t){var e=t[0],i=t[1],n=t[2],r=o(n);self.postMessage({method:e,uid:i,data:n},r)},s.prototype.emit=function(t,e){self.postMessage({eventName:t,data:e})},{Client:r,Server:s}});
