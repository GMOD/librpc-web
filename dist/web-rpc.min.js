!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WebRPC=e()}(this,function(){"use strict";function t(t){return Object(t)===t}function e(t){return t instanceof ArrayBuffer}function o(r,n){if(void 0===n&&(n=[]),e(r))n.push(r);else if(t(r))for(var i in r)o(r[i],n);return n}function r(){return Math.floor(1e10*(1+Math.random())).toString(16)}var n=function(){this.events=Object.create(null)};n.prototype.on=function(t,e){var o=this.events[t];o||(o=[],this.events[t]=o),o.push(e)},n.prototype.off=function(t,e){var o=this.events[t];if(o){var r=o.indexOf(e);-1!==r&&o.splice(r,1)}},n.prototype.emit=function(t,e){var o=this.events[t];if(o)for(var r=0;r<o.length;r++)o[r](e)};var i=function(t){function e(e){var o=e.workers;t.call(this),this.workers=[].concat(o),this.idx=0,this.calls={},this.timeouts={},this.errors={},this.handler=this.handler.bind(this),this.listen()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.listen=function(){var t=this;this.workers.forEach(function(e){return e.addEventListener("message",t.handler)})},e.prototype.handler=function(t){var e=t.data,o=e.error,r=e.method,n=e.eventName,i=e.data,s=e.uid;o?this.reject(s,o):r?this.resolve(s,i):n&&this.emit(n,i)},e.prototype.reject=function(t,e){this.errors[t]&&(this.errors[t](new Error(e)),this.clear(t))},e.prototype.resolve=function(t,e){this.calls[t]&&(this.calls[t](e),this.clear(t))},e.prototype.clear=function(t){clearTimeout(this.timeouts[t]),delete this.timeouts[t],delete this.calls[t],delete this.errors[t]},e.prototype.call=function(t,e,n){var i=this;void 0===n&&(n={});var s=n.timeout;void 0===s&&(s=2e3);var a=r(),h=o(e);return new Promise(function(o,r){i.timeouts[a]=setTimeout(function(){return i.reject(a,'Timeout exceeded for RPC method "'+t+'"')},s),i.calls[a]=o,i.errors[a]=r,i.workers[i.idx].postMessage({method:t,uid:a,data:e},h),i.idx=++i.idx%i.workers.length})},e}(n),s=function(t){this.methods=t,this.listen()};return s.prototype.listen=function(){self.addEventListener("message",this.handler.bind(this))},s.prototype.handler=function(t){var e=this,o=t.data,r=o.method,n=o.uid,i=o.data;this.methods[r]?Promise.resolve(i).then(this.methods[r]).then(function(t){return e.reply(n,r,t)},function(t){return e.throw(n,t)}):this.throw(n,'Unknown RPC method "'+r+'"')},s.prototype.reply=function(t,e,r){var n=o(r);self.postMessage({uid:t,method:e,data:r},n)},s.prototype.throw=function(t,e){self.postMessage({uid:t,error:e})},s.prototype.emit=function(t,e){self.postMessage({eventName:t,data:e})},{Client:i,Server:s}});
