!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WebRPC=e()}(this,function(){"use strict";function t(t){return Object(t)===t}function e(t){return t instanceof ArrayBuffer}function i(i){var n=[];if(e(i))n.push(i);else if(t(i))for(var o in i)e(i[o])&&n.push(i[o]);return n}function n(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(t){return(t^r.getRandomValues(s)[0]&15>>t/4).toString(16)})}var o=function(){this.events=Object.create(null)};o.prototype.on=function(t,e){var i=this.events[t];i||(i=[],this.events[t]=i),i.push(e)},o.prototype.off=function(t,e){var i=this.events[t];if(i){var n=i.indexOf(e);-1!==n&&i.splice(n,1)}},o.prototype.emit=function(t,e){var i=this.events[t];if(i)for(var n=0;n<i.length;n++)i[n](e)};var r=window.crypto||window.msCrypto,s=new Uint8Array(1),a=function(t){function e(e){var i=e.workers;t.call(this),this.workers=i,this.idx=0,this.calls={},this.timeouts={},this.handler=this.handler.bind(this),this.listen()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.listen=function(){var t=this;this.workers.forEach(function(e){return e.addEventListener("message",t.handler)})},e.prototype.handler=function(t){var e=t.data,i=e.method,n=e.eventName,o=e.data,r=e.uid;i&&this.resolve(r,o),n&&this.emit(n,o)},e.prototype.resolve=function(t,e){this.calls[t]&&(clearTimeout(this.timeouts[t]),this.calls[t](e),delete this.timeouts[t],delete this.calls[t])},e.prototype.call=function(t,e,o){var r=this;void 0===o&&(o={});var s=o.timeout;void 0===s&&(s=2e3);var a=n(),u=i(e);return this.workers[this.idx].postMessage({method:t,uid:a,data:e},u),this.idx=++this.idx%this.workers.length,new Promise(function(e,i){r.timeouts[a]=setTimeout(function(){return i(new Error("RPC timeout exceeded for '"+t+"' call"))},s),r.calls[a]=e})},e}(o),u=function(t){this.methods=t,this.listen()};return u.prototype.listen=function(){self.addEventListener("message",this.handler.bind(this))},u.prototype.handler=function(t){var e=t.data,i=e.method,n=e.uid,o=e.data;this.methods[i]&&Promise.all([i,n,this.methods[i](o)]).then(this.reply)},u.prototype.reply=function(t){var e=t[0],n=t[1],o=t[2],r=i(o);self.postMessage({method:e,uid:n,data:o},r)},u.prototype.emit=function(t,e){self.postMessage({eventName:t,data:e})},{Client:a,Server:u}});
