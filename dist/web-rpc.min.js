!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WebRPC=e()}(this,function(){"use strict";function t(t){return Object(t)===t}function e(t){return t instanceof ArrayBuffer}function r(r){var o=[];if(e(r))o.push(r);else if(t(r))for(var i in r)e(r[i])&&o.push(r[i]);return o}function o(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(t){return(t^n.getRandomValues(s)[0]&15>>t/4).toString(16)})}var i=function(){this.events=Object.create(null)};i.prototype.on=function(t,e){var r=this.events[t];r||(r=[],this.events[t]=r),r.push(e)},i.prototype.off=function(t,e){var r=this.events[t];if(r){var o=r.indexOf(e);-1!==o&&r.splice(o,1)}},i.prototype.emit=function(t,e){var r=this.events[t];if(r)for(var o=0;o<r.length;o++)r[o](e)};var n=window.crypto||window.msCrypto,s=new Uint8Array(1),a=function(t){function e(e){var r=e.workers;t.call(this),this.workers=[].concat(r),this.idx=0,this.calls={},this.timeouts={},this.errors={},this.handler=this.handler.bind(this),this.listen()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.listen=function(){var t=this;this.workers.forEach(function(e){return e.addEventListener("message",t.handler)})},e.prototype.handler=function(t){var e=t.data,r=e.error,o=e.method,i=e.eventName,n=e.data,s=e.uid;r&&this.reject(s,r),o&&this.resolve(s,n),i&&this.emit(i,n)},e.prototype.reject=function(t,e){this.errors[t]&&(this.errors[t](new Error(e)),this.clear(t))},e.prototype.resolve=function(t,e){this.calls[t]&&(this.calls[t](e),this.clear(t))},e.prototype.clear=function(t){clearTimeout(this.timeouts[t]),delete this.timeouts[t],delete this.calls[t],delete this.errors[t]},e.prototype.call=function(t,e,i){var n=this;void 0===i&&(i={});var s=i.timeout;void 0===s&&(s=2e3);var a=o(),h=r(e);return this.workers[this.idx].postMessage({method:t,uid:a,data:e},h),this.idx=++this.idx%this.workers.length,new Promise(function(e,r){n.timeouts[a]=setTimeout(function(){return n.reject("RPC timeout exceeded for '"+t+"' call")},s),n.calls[a]=e})},e}(i),h=function(t){this.methods=t,this.listen()};return h.prototype.listen=function(){self.addEventListener("message",this.handler.bind(this))},h.prototype.handler=function(t){var e=this,r=t.data,o=r.method,i=r.uid,n=r.data;this.methods[o]?Promise.all([this.methods[o](n)]).then(function(t){return e.reply(i,o,t)},function(t){return e.throw(i,t)}):this.throw(i,"Unknown RPC method: "+o)},h.prototype.reply=function(t,e,o){var i=r(o);self.postMessage({uid:t,method:e,data:o},i)},h.prototype.throw=function(t,e){self.postMessage({uid:t,error:e})},h.prototype.emit=function(t,e){self.postMessage({eventName:t,data:e})},{Client:a,Server:h}});
