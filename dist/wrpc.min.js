!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WRPC=e()}(this,function(){"use strict";function t(t){return Object(t)===t}function e(t){return t instanceof ArrayBuffer}function i(i){var n=[];if(e(i))n.push(i);else if(t(i))for(var o in i)e(i[o])&&n.push(i[o]);return n}var n=function(t){var e=t.worker;this.worker=e,this.events={},this.calls={},this.timeouts={},this.listen()};n.prototype.listen=function(){this.worker.addEventListener("message",this.handler.bind(this))},n.prototype.handler=function(t){var e=t.data,i=e.method,n=e.eventName,o=e.data,s=e.uid;i&&this.resolve(s,o),n&&this.trigger(n,o)},n.prototype.call=function(t,e,n){var o=this;void 0===n&&(n={});var s=n.timeout;void 0===s&&(s=2e3);var r=this.guid(),a=i(e);return this.worker.postMessage({method:t,uid:r,data:e},a),new Promise(function(e,i){o.timeouts[r]=setTimeout(function(){return i(new Error("RPC timeout exceeded for '"+t+"' call"))},s),o.calls[r]=e})},n.prototype.guid=function(){return Math.floor(1e6*(1+Math.random())).toString(16)},n.prototype.resolve=function(t,e){this.calls[t]&&(clearTimeout(this.timeouts[t]),this.calls[t](e),delete this.timeouts[t],delete this.calls[t])},n.prototype.on=function(t,e){var i=this.events[t]||[];(this.events[t]=i).push(e)},n.prototype.off=function(t,e){var i=(this.events[t]||[]).indexOf(e);-1!==i&&this.events[t].splice(i,1)},n.prototype.trigger=function(t,e){for(var i=this.events[t]||[],n=0;n<i.length;n++)i[n](e)};var o=function(t){this.handlers=t,this.listen()};return o.prototype.listen=function(){self.addEventListener("message",this.handler.bind(this))},o.prototype.handler=function(t){var e=t.data,i=e.method,n=e.uid,o=e.data;this.handlers[i]&&Promise.all([i,n,this.handlers[i](o)]).then(this.reply)},o.prototype.reply=function(t){var e=t[0],n=t[1],o=t[2],s=i(o);self.postMessage({method:e,uid:n,data:o},s)},o.prototype.emit=function(t,e){self.postMessage({eventName:t,data:e})},{Client:n,Server:o}});
